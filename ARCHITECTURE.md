# MT4 Trading Tools アーキテクチャ設計書

## 1. システム概要

MT4 Trading Toolsは、MetaTrader 4プラットフォーム上で動作する統合トレーディングシステムです。プラグインアーキテクチャを採用し、柔軟で拡張可能な設計となっています。

## 2. アーキテクチャ概観

```
┌─────────────────────────────────────────────────────────────┐
│                        MetaTrader 4                         │
├─────────────────────────────────────────────────────────────┤
│                    UnifiedTradingEA.mq4                     │
│                      （コアシステム）                        │
├─────────────────────┬───────────────┬─────────────────────┤
│   PluginManager     │  OrderManager │  AccountManager     │
│  （プラグイン管理）   │  （注文管理）   │  （口座管理）       │
├─────────────────────┴───────────────┴─────────────────────┤
│                    PluginBase.mqh                          │
│                 （プラグイン基底クラス）                      │
├──────────────┬──────────────┬──────────────┬─────────────┤
│ Breakout     │ RiskManager  │   Future     │    ...      │
│ Plugin       │   Plugin     │  Plugins     │             │
└──────────────┴──────────────┴──────────────┴─────────────┘
```

## 3. コアコンポーネント

### 3.1 UnifiedTradingEA
- **役割**: システム全体の制御とプラグインの統合
- **責務**:
  - プラグインの登録と初期化
  - イベントの配信（OnTick, OnTimer等）
  - GUI統合
  - 共通設定の管理

### 3.2 PluginManager
- **役割**: プラグインのライフサイクル管理
- **主要メソッド**:
  ```mql4
  RegisterPlugin(CPluginBase* plugin)  // プラグイン登録
  InitializeAll()                      // 全プラグイン初期化
  OnTick()                            // ティックイベント配信
  ```

### 3.3 OrderManager
- **役割**: 注文の実行と管理
- **機能**:
  - 注文発注（買い/売り）
  - ポジション管理
  - トレーリングストップ
  - 部分決済

### 3.4 AccountManager
- **役割**: 口座情報と資金管理
- **機能**:
  - 自動ロットサイズ計算
  - リスク管理
  - 日次統計
  - 収益計算

## 4. プラグインシステム

### 4.1 プラグインインターフェース（CPluginBase）

```mql4
class CPluginBase {
    // 必須実装メソッド
    virtual bool OnInit() = 0;
    virtual void OnDeinit() = 0;
    virtual void OnTick() = 0;
    
    // オプションメソッド
    virtual void OnTrade() {}
    virtual void OnTimer() {}
    virtual void OnChartEvent() {}
    virtual void CreateSettingsPanel() {}
    virtual bool SaveSettings() {}
    virtual bool LoadSettings() {}
}
```

### 4.2 プラグインのライフサイクル

```
1. 登録 (RegisterPlugin)
    ↓
2. 初期化 (OnInit)
    ↓
3. 有効化 (Enable)
    ↓
4. 実行 (OnTick, OnTimer等)
    ↓
5. 無効化 (Disable)
    ↓
6. 終了 (OnDeinit)
```

### 4.3 実装済みプラグイン

#### BreakoutPlugin
- **機能**: 価格ブレイクアウトの検出と自動エントリー
- **設定**:
  - 判定期間
  - ブレイクアウトバッファ
  - トレンドフィルター
  - アラート設定

#### RiskManagerPlugin
- **機能**: 自動リスク管理
- **設定**:
  - 最大損失（トレード/日次）
  - トレーリングストップ
  - 部分決済
  - ブレークイーブン

## 5. データフロー

```
市場データ
    ↓
MetaTrader 4
    ↓
UnifiedTradingEA
    ↓
PluginManager ──→ 各プラグイン
    ↓                ↓
OrderManager ←──── 取引シグナル
    ↓
注文実行
```

## 6. GUI アーキテクチャ

### 6.1 レイアウト構造

```
┌─────────────────────────┐
│   メインパネル          │
├─────────────────────────┤
│ 口座情報               │
│ ・残高                 │
│ ・有効証拠金           │
│ ・ロットサイズ         │
├─────────────────────────┤
│ コントロールボタン      │
│ [全決済] [設定]        │
├─────────────────────────┤
│ プラグイン設定パネル    │
│ （展開可能）           │
└─────────────────────────┘
```

### 6.2 イベント処理

- チャートクリックイベント → 各プラグインに配信
- 設定変更 → プラグインの設定を更新
- 表示更新 → OnTimerで定期的に更新

## 7. 設定管理

### 7.1 設定の階層

```
グローバル設定（EA全体）
├── 基本設定（ロット、リスク等）
└── プラグイン設定
    ├── BreakoutPlugin設定
    ├── RiskManagerPlugin設定
    └── その他プラグイン設定
```

### 7.2 永続化

- 各プラグインが独自の設定ファイルを管理
- ファイル形式: テキストファイル（.set）
- 保存場所: MetaTrader 4のFilesフォルダ

## 8. エラー処理とログ

### 8.1 エラー処理方針

1. **フェイルセーフ**: エラー時は安全側に倒す
2. **ログ出力**: すべてのエラーをログに記録
3. **ユーザー通知**: 重要なエラーはアラート表示

### 8.2 ログレベル

- ERROR: システムエラー、取引失敗
- WARN: 警告（リスク制限接近等）
- INFO: 通常動作ログ
- DEBUG: デバッグ情報（開発時のみ）

## 9. パフォーマンス考慮事項

### 9.1 最適化戦略

1. **イベント駆動**: 必要な時のみ処理実行
2. **キャッシュ**: 頻繁に使用するデータをキャッシュ
3. **遅延評価**: 重い処理は必要になるまで実行しない

### 9.2 リソース管理

- オブジェクトの適切な削除
- メモリリークの防止
- ファイルハンドルの管理

## 10. セキュリティ

### 10.1 取引安全性

- 最大ポジション数制限
- 日次損失制限
- 異常値検出

### 10.2 データ保護

- 設定ファイルの検証
- 入力値のサニタイズ
- エラー時の安全なフォールバック

## 11. 拡張ガイドライン

### 11.1 新規プラグイン開発手順

1. `Include/Plugins/`に新規ファイル作成
2. `CPluginBase`を継承
3. 必須メソッドを実装
4. UnifiedTradingEAに登録コードを追加
5. テストとデバッグ

### 11.2 プラグイン開発のベストプラクティス

- 単一責任の原則を守る
- 他のプラグインとの依存を最小化
- 設定は外部化する
- エラー処理を適切に行う
- ドキュメントを充実させる

## 12. 今後の拡張計画

### 12.1 短期計画

- プラグイン間通信機能
- 外部設定ファイル（JSON/XML）対応
- バックテスト最適化機能

### 12.2 長期計画

- 機械学習プラグイン
- Web API連携
- マルチ通貨ペア対応
- クラウド同期機能

## 13. 制約事項

### 13.1 MT4プラットフォームの制約

- 1チャートに1EA制限（本システムで解決）
- MQL4言語の制約
- バックテストの精度限界

### 13.2 設計上の制約

- プラグイン数の実用的な上限（10個程度）
- GUI要素数の制限
- ファイルサイズ制限

## 14. 用語集

- **EA (Expert Advisor)**: 自動売買プログラム
- **プラグイン**: 機能を追加するモジュール
- **ティック**: 価格更新イベント
- **pips**: 価格の最小変動単位
- **トレーリングストップ**: 利益を確保する動的ストップロス

---

最終更新日: 2025年1月
バージョン: 1.0